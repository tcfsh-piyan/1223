<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Master V3.9 - 穩定與分層版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .option-btn:hover { background-color: #f8fafc; transform: translateX(6px); }
        .correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); }
        .wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
        .sidebar-item:hover { background-color: #334155; }
        .passage-box { background-color: #f8fafc; border-left: 6px solid #3b82f6; padding: 1.5rem; margin-bottom: 2rem; border-radius: 1rem; line-height: 1.8; color: #1e293b; white-space: pre-wrap; font-size: 1.05rem; }
        .rationale-content { white-space: pre-wrap; line-height: 1.7; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0) !important; }
        .view-active { display: flex !important; }
        .nav-btn-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex text-slate-800 font-sans overflow-x-hidden">

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden opacity-0 transition-opacity"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-slate-900 text-slate-300 flex flex-col z-30 -translate-x-full md:translate-x-0 md:static md:z-auto shadow-2xl">
        <div class="p-8 font-black text-white text-2xl tracking-tighter border-b border-white/5 flex items-center justify-between">
            <span>STUDY MASTER</span>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-500">✕</button>
        </div>
        
        <div class="p-4 bg-slate-800/50 m-4 rounded-2xl border border-slate-700">
            <div class="flex items-center justify-between mb-2">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Cloud Sync</span>
                <div id="sync-indicator" class="w-2 h-2 rounded-full bg-red-500"></div>
            </div>
            <div class="flex gap-2">
                <input type="password" id="sync-key" class="flex-1 bg-slate-900 border-none rounded-xl p-2.5 text-xs text-white outline-none focus:ring-1 focus:ring-blue-500" placeholder="金鑰...">
                <button onclick="initSync()" class="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold text-white">連線</button>
            </div>
        </div>

        <div id="quiz-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 z-10 shadow-sm">
            <div class="flex justify-between items-center p-4 md:p-6">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 hover:bg-slate-100 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <div id="current-title" class="font-black text-slate-800 text-lg md:text-xl truncate max-w-[150px]">STUDY MASTER</div>
                </div>
                <nav class="flex gap-6 text-sm font-bold text-slate-400">
                    <button id="nav-study" onclick="switchView('study')" class="nav-btn nav-btn-active pb-1">學習空間</button>
                    <button id="nav-creator" onclick="switchView('creator')" class="nav-btn pb-1">工作室</button>
                </nav>
            </div>
        </header>

        <div id="main-content" class="flex-1 overflow-y-auto p-4 md:p-12 flex flex-col items-center">
            
            <div id="view-study" class="view-active w-full max-w-4xl flex-col hidden">
                <div id="quiz-stats" class="hidden flex justify-between w-full mb-6">
                    <span id="timer" class="font-mono text-blue-600 bg-blue-50 px-4 py-1 rounded-full font-bold">00:00</span>
                    <span id="progress" class="text-slate-400 font-bold text-sm">0 / 0</span>
                </div>
                <div id="quiz-screen" class="bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl border border-slate-100 hidden">
                    <div id="passage-display" class="passage-box hidden"></div>
                    <div id="question-text" class="text-2xl font-bold text-slate-800 leading-snug mb-10 whitespace-pre-line"></div>
                    <div id="options-container" class="space-y-4"></div>
                    <button id="next-btn" onclick="nextQuestion()" class="hidden mt-12 w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl shadow-xl">下一題</button>
                </div>
                <div id="result-screen" class="hidden w-full space-y-10"></div>
                <div id="welcome-screen" class="text-center py-20">
                    <h2 class="text-4xl font-black text-slate-900 mb-4">準備好開始了嗎？</h2>
                    <p class="text-slate-400">請從左側選單選擇一個題組進入學習模式。</p>
                </div>
            </div>

            <div id="view-creator" class="w-full max-w-4xl flex-col hidden">
                <div class="bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl border border-slate-100">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">創作者工作室</h2>
                            <p class="text-slate-400">在這裡管理您的素材與 AI 出題</p>
                        </div>
                        <span class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold uppercase tracking-widest text-slate-400">Admin Mode</span>
                    </div>
                    
                    <input type="text" id="new-quiz-name" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="設定題庫標題...">
                    <textarea id="import-input" class="w-full h-80 p-6 bg-slate-50 rounded-2xl font-mono text-sm mb-6 border-none outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="貼上文字內容..."></textarea>
                    
                    <div class="flex gap-4">
                        <button onclick="handleImport()" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black text-lg hover:bg-black transition-all">手動匯入並同步</button>
                        <button class="bg-blue-100 text-blue-600 px-8 py-5 rounded-2xl font-black text-lg opacity-50 cursor-not-allowed">Gemini AI 出題 (開發中)</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Firebase Config (請保持使用您之前的設定) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD719pOpRDq9gfn8MpRsKILmYY8d0y-3n4",
            authDomain: "learning-41290.firebaseapp.com",
            projectId: "learning-41290",
            storageBucket: "learning-41290.firebasestorage.app",
            messagingSenderId: "451785140537",
            appId: "1:451785140537:web:668bc05ffa6fe68a51e0e8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 離線持久化補丁 (穩定性關鍵)
        firebase.firestore().enablePersistence().catch(err => console.log("Persistence failed", err.code));

        let allQuizzes = [];
        let syncKey = localStorage.getItem('master_sync_key') || '';
        if(syncKey) { document.getElementById('sync-key').value = syncKey; }

        // --- 前後台切換邏輯 ---
        function switchView(view) {
            document.querySelectorAll('#main-content > div').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            
            if (view === 'study') {
                document.getElementById('view-study').classList.remove('hidden');
                document.getElementById('nav-study').classList.add('nav-btn-active');
            } else {
                document.getElementById('view-creator').classList.remove('hidden');
                document.getElementById('nav-creator').classList.add('nav-btn-active');
            }
        }

        // --- 同步邏輯 (增加自動重連) ---
        async function initSync() {
            const key = document.getElementById('sync-key').value.trim();
            if (!key) return;
            syncKey = key;
            localStorage.setItem('master_sync_key', key);
            
            document.getElementById('sync-indicator').className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            
            try {
                // 使用 onSnapshot 實現即時監聽 (比之前更穩)
                db.collection("users").doc(syncKey).onSnapshot((doc) => {
                    if (doc.exists) {
                        allQuizzes = doc.data().quizzes || [];
                        renderList();
                        document.getElementById('sync-indicator').className = "w-2 h-2 rounded-full bg-emerald-500";
                    } else {
                        db.collection("users").doc(syncKey).set({ quizzes: [] });
                        document.getElementById('sync-indicator').className = "w-2 h-2 rounded-full bg-emerald-500";
                    }
                }, err => {
                    document.getElementById('sync-indicator').className = "w-2 h-2 rounded-full bg-red-500";
                });
            } catch (e) { console.error(e); }
        }

        // --- 核心解析與測驗邏輯 (延續 V3.8 的高品質解析) ---
        function renderList() {
            const list = document.getElementById('quiz-list');
            list.innerHTML = '';
            allQuizzes.forEach((q, idx) => {
                const item = document.createElement('div');
                item.className = "sidebar-item p-4 rounded-2xl cursor-pointer text-sm font-bold transition flex justify-between group items-center bg-slate-800/50";
                item.innerHTML = `<span class="truncate pr-2 text-slate-400 group-hover:text-white">${q.name}</span><button onclick="deleteQuiz(event, ${idx})" class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400">✕</button>`;
                item.onclick = () => { 
                    loadQuiz(idx); 
                    switchView('study'); // 點選題目自動跳轉到學習空間
                    if(window.innerWidth < 768) toggleSidebar(); 
                };
                list.appendChild(item);
            });
        }

        async function handleImport() {
            const name = document.getElementById('new-quiz-name').value || `題組 ${new Date().toLocaleDateString()}`;
            const parsed = smartParse(document.getElementById('import-input').value); // 此函數同 V3.8
            if (parsed.length === 0) return alert("解析失敗！");
            
            allQuizzes.push({ name, data: parsed });
            await db.collection("users").doc(syncKey).set({ quizzes: allQuizzes });
            alert("題組已同步至雲端工作室！");
            document.getElementById('new-quiz-name').value = "";
            document.getElementById('import-input').value = "";
        }

        // [smartParse, loadQuiz, nextQuestion, showResult 等函數皆同 V3.8, 此處為簡潔略過，請合併使用]
        // ... (保持 V3.8 的完整解析函數邏輯) ...
        
        if(syncKey) initSync(); // 初始化自動連線
    </script>
</body>
</html>
